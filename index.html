<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
  <title>360¬∞ –ú–∏–Ω–∏-–∞–ø–ø</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      overflow: hidden;
    }
    #pano {
      position: fixed;
      inset: 0;
      width: 100%;
      height: 100%;
      touch-action: none;
    }
    .toolbar {
      position: fixed; top: 10px; left: 10px; right: 10px; display: flex;
      gap: 8px; z-index: 10; align-items: center; justify-content: space-between;
      padding: 6px 10px; border-radius: 12px; backdrop-filter: blur(6px);
      background: rgba(0,0,0,.35); color: #fff; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
    }
    .toolbar .title { font-weight: 600; font-size: 14px; }
    .toolbar .btns { display: flex; gap: 8px; }
    .btn {
      border: none; padding: 8px 12px; border-radius: 10px; cursor: pointer;
      background: rgba(255,255,255,.9);
    }
  </style>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="libs/marzipano.min.js"></script>
</head>
<body>
  <div class="toolbar">
    <div class="title">üì∑ 360¬∞ –ü—Ä–æ—Å–º–æ—Ç—Ä</div>
    <div class="btns">
      <button class="btn" id="zoomIn">+</button>
      <button class="btn" id="zoomOut">‚àí</button>
      <button class="btn" id="reset">Reset</button>
    </div>
  </div>
  <div id="pano"></div>

  <script src="data.js"></script>
  <script>
    const setBackground = (color) => {
      if (color) {
        document.body.style.background = color;
      }
    };

    const tg = window.Telegram?.WebApp || null;
    if (tg) {
      tg.ready();
      tg.expand();
      const tp = tg.themeParams || {};
      setBackground(tp.bg_color || '#000');
      tg.MainButton.hide();
    } else {
      setBackground('#000');
      console.log('—Ä–µ–∂–∏–º –±—Ä–∞—É–∑–µ—Ä–∞');
    }

    const panoEl = document.getElementById('pano');
    if (!panoEl) {
      console.warn('pano element not found');
    } else {
      let touchStart = null;

      const resetTouch = () => {
        touchStart = null;
      };

      panoEl.addEventListener('touchstart', (event) => {
        if (event.touches.length === 1) {
          const touch = event.touches[0];
          touchStart = { x: touch.clientX, y: touch.clientY };
        } else {
          touchStart = null;
        }
      }, { passive: false });

      panoEl.addEventListener('touchmove', (event) => {
        if (!touchStart || event.touches.length !== 1) {
          return;
        }

        const touch = event.touches[0];
        const deltaX = touch.clientX - touchStart.x;
        const deltaY = touch.clientY - touchStart.y;
        if (deltaY > 2 && Math.abs(deltaY) >= Math.abs(deltaX)) {
          event.preventDefault();
        }
      }, { passive: false });

      panoEl.addEventListener('touchend', resetTouch, { passive: true });
      panoEl.addEventListener('touchcancel', resetTouch, { passive: true });

      const viewer = new Marzipano.Viewer(panoEl);
      const sceneData = window.DATA?.scene;

      if (!sceneData || !sceneData.url) {
        panoEl.innerHTML = "<p style='color:white;text-align:center;margin-top:40vh'>–î–æ–±–∞–≤—å —Å–≤–æ–π —Ñ–∞–π–ª –≤ –ø–∞–ø–∫—É panos/ –∏ —É–∫–∞–∂–∏ –ø—É—Ç—å –≤ data.js</p>";
      } else {
        const source = Marzipano.ImageUrlSource.fromString(sceneData.url);
        const geometry = new Marzipano.EquirectGeometry([{ width: sceneData.width || 8000 }]);
        const minFov = 0.25;
        const maxFov = 1.5;
        const clampFov = (value) => Math.min(maxFov, Math.max(minFov, value));
        const limiter = Marzipano.RectilinearView.limit.zoom(minFov, maxFov);
        const view = new Marzipano.RectilinearView(
          { yaw: sceneData.yaw||0, pitch: sceneData.pitch||0, fov: clampFov(sceneData.fov||1.2) },
          limiter
        );
        const scene = viewer.createScene({ source, geometry, view, pinFirstLevel: true });
        scene.switchTo();

        document.getElementById('zoomIn').onclick = () => view.setFov(clampFov(view.fov() * 0.9));
        document.getElementById('zoomOut').onclick = () => view.setFov(clampFov(view.fov() / 0.9));
        document.getElementById('reset').onclick = () => view.setParameters({ yaw: 0, pitch: 0, fov: clampFov(1.2) });

        const controls = viewer.controls();
        if (controls && typeof controls.registerMethod === 'function') {
          const ensureMethod = (name, handlerFactory) => {
            const existing = typeof controls.method === 'function' ? controls.method(name) : null;
            if (!existing) {
              controls.registerMethod(name, handlerFactory(), true);
            }
          };

          ensureMethod('mouseViewDrag', () => new Marzipano.MouseViewDragHandler(view));
          ensureMethod('touchViewDrag', () => new Marzipano.TouchViewDragHandler(view));
          ensureMethod('scrollZoom',    () => new Marzipano.ScrollZoomHandler(view));
          ensureMethod('pinchZoom',     () => new Marzipano.PinchZoomHandler(view));
        }
      }
    }
  </script>
</body>
</html>
