<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
  <title>360¬∞ –ú–∏–Ω–∏-–∞–ø–ø</title>
  <style>
    html,body{height:100%;margin:0;overflow:hidden;overscroll-behavior:none;-webkit-overflow-scrolling:auto}
  </style>
  <style>
    html, body { height: 100%; margin: 0; background: #000; }
    #pano { width: 100%; height: 100%; }
    .toolbar {
      position: fixed; top: 10px; left: 10px; right: 10px; display: flex;
      gap: 8px; z-index: 10; align-items: center; justify-content: space-between;
      padding: 6px 10px; border-radius: 12px; backdrop-filter: blur(6px);
      background: rgba(0,0,0,.35); color: #fff; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
    }
    .toolbar .title { font-weight: 600; font-size: 14px; }
    .toolbar .btns { display: flex; gap: 8px; }
    .btn {
      border: none; padding: 8px 12px; border-radius: 10px; cursor: pointer;
      background: rgba(255,255,255,.9);
    }
  </style>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="libs/marzipano.min.js"></script>
</head>
<body>
  <div class="toolbar">
    <div class="title">üì∑ 360¬∞ –ü—Ä–æ—Å–º–æ—Ç—Ä</div>
    <div class="btns">
      <button class="btn" id="zoomIn">+</button>
      <button class="btn" id="zoomOut">‚àí</button>
      <button class="btn" id="reset">Reset</button>
    </div>
  </div>
  <div id="pano"></div>

  <script src="data.js"></script>
  <script>
    const tg = window.Telegram?.WebApp || null;
    if (tg) {
      tg.ready();
      tg.expand();
      const tp = tg.themeParams || {};
      if (tp.bg_color) document.body.style.background = tp.bg_color;
      tg.MainButton.hide();
    }

    const viewer = new Marzipano.Viewer(document.getElementById('pano'));
    const sceneData = window.DATA?.scene;

    if (!sceneData || !sceneData.url) {
      document.getElementById("pano").innerHTML = "<p style='color:white;text-align:center;margin-top:40vh'>–î–æ–±–∞–≤—å —Å–≤–æ–π —Ñ–∞–π–ª –≤ –ø–∞–ø–∫—É panos/ –∏ —É–∫–∞–∂–∏ –ø—É—Ç—å –≤ data.js</p>";
    } else {
      const source = Marzipano.ImageUrlSource.fromString(sceneData.url);
      const geometry = new Marzipano.EquirectGeometry([{ width: sceneData.width || 8000 }]);
      const limiter = Marzipano.RectilinearView.limit.traditional(1024, Math.PI/2);
      const view = new Marzipano.RectilinearView(
        { yaw: sceneData.yaw||0, pitch: sceneData.pitch||0, fov: sceneData.fov||1.2 },
        limiter
      );
      const scene = viewer.createScene({ source, geometry, view, pinFirstLevel: true });
      scene.switchTo();

      document.getElementById('zoomIn').onclick = () => view.setFov(view.fov() * 0.9);
      document.getElementById('zoomOut').onclick = () => view.setFov(view.fov() / 0.9);
      document.getElementById('reset').onclick = () => view.setParameters({ yaw: 0, pitch: 0, fov: 1.2 });
    }
  </script>
  <script>
    (function guardIOS(){
      var el = document.getElementById('pano');
      if (!el) return;
      var dragging = false, startY = 0;

      el.addEventListener('touchstart', function(e){
        if (e.touches && e.touches.length === 1) {
          dragging = true;
          startY = e.touches[0].clientY;
        } else {
          dragging = false; // –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ–º –º—É–ª—å—Ç–∏—Ç–∞—á (–ø–∏–Ω—á-–∑—É–º–∞)
        }
      }, { passive: false });

      el.addEventListener('touchmove', function(e){
        // –¥–ª—è –¥–≤—É—Ö –∏ –±–æ–ª–µ–µ –ø–∞–ª—å—Ü–µ–≤ ‚Äî –Ω–∏—á–µ–≥–æ –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ–º (–æ—Å—Ç–∞–≤–ª—è–µ–º –ø–∏–Ω—á)
        if (e.touches && e.touches.length >= 2) return;
        if (dragging && e.touches && e.touches[0]) {
          var dy = e.touches[0].clientY - startY;
          // –ø—Ä–∏ –∑–∞–º–µ—Ç–Ω–æ–º –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ–º –¥–≤–∏–∂–µ–Ω–∏–∏ –æ–¥–Ω–∏–º –ø–∞–ª—å—Ü–µ–º ‚Äî –Ω–µ –æ—Ç–¥–∞—ë–º –∂–µ—Å—Ç –æ–±–æ–ª–æ—á–∫–µ
          if (Math.abs(dy) > 2) e.preventDefault();
        }
      }, { passive: false });

      el.addEventListener('touchend', function(){ dragging = false; }, { passive: false });
    })();
  </script>
</body>
</html>
