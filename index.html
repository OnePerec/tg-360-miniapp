<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
  <title>360¬∞ –ú–∏–Ω–∏-–∞–ø–ø</title>
  <style>
    html, body {
      height: 100%;
      margin: 0;
      background: #000;
      overflow: hidden;
      overscroll-behavior: none;
      -webkit-overflow-scrolling: auto;
      touch-action: none;
    }
    #pano {
      position: fixed;
      inset: 0;
      touch-action: none;
    }
    .toolbar {
      position: fixed; top: 10px; left: 10px; right: 10px; display: flex;
      gap: 8px; z-index: 10; align-items: center; justify-content: space-between;
      padding: 6px 10px; border-radius: 12px; backdrop-filter: blur(6px);
      background: rgba(0,0,0,.35); color: #fff; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
    }
    .toolbar .title { font-weight: 600; font-size: 14px; }
    .toolbar .btns { display: flex; gap: 8px; }
    .btn {
      border: none; padding: 8px 12px; border-radius: 10px; cursor: pointer;
      background: rgba(255,255,255,.9);
    }
  </style>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="libs/marzipano.min.js"></script>
</head>
<body>
  <div class="toolbar">
    <div class="title">üì∑ 360¬∞ –ü—Ä–æ—Å–º–æ—Ç—Ä</div>
    <div class="btns">
      <button class="btn" id="zoomIn">+</button>
      <button class="btn" id="zoomOut">‚àí</button>
      <button class="btn" id="reset">Reset</button>
    </div>
  </div>
  <div id="pano"></div>

  <script src="data.js"></script>
  <script>
    const tg = window.Telegram?.WebApp || null;
    if (tg) {
      tg.ready();
      tg.expand();
      const tp = tg.themeParams || {};
      if (tp.bg_color) document.body.style.background = tp.bg_color;
      tg.MainButton.hide();
    }

    const panoEl = document.getElementById('pano');
    if (panoEl) {
      let touchStartY = null;

      const resetTouch = () => {
        touchStartY = null;
      };

      panoEl.addEventListener('touchstart', (event) => {
        if (event.touches.length === 1) {
          touchStartY = event.touches[0].clientY;
        } else {
          touchStartY = null;
        }
      }, { passive: false });

      panoEl.addEventListener('touchmove', (event) => {
        if (touchStartY === null || event.touches.length !== 1) {
          return;
        }

        const currentY = event.touches[0].clientY;
        if (Math.abs(currentY - touchStartY) > 2) {
          event.preventDefault();
        }
      }, { passive: false });

      panoEl.addEventListener('touchend', resetTouch, { passive: true });
      panoEl.addEventListener('touchcancel', resetTouch, { passive: true });
    }

    const viewer = new Marzipano.Viewer(document.getElementById('pano'));
    const sceneData = window.DATA?.scene;

    if (!sceneData || !sceneData.url) {
      document.getElementById("pano").innerHTML = "<p style='color:white;text-align:center;margin-top:40vh'>–î–æ–±–∞–≤—å —Å–≤–æ–π —Ñ–∞–π–ª –≤ –ø–∞–ø–∫—É panos/ –∏ —É–∫–∞–∂–∏ –ø—É—Ç—å –≤ data.js</p>";
    } else {
      const source = Marzipano.ImageUrlSource.fromString(sceneData.url);
      const geometry = new Marzipano.EquirectGeometry([{ width: sceneData.width || 8000 }]);
      const limiter = Marzipano.RectilinearView.limit.traditional(1024, Math.PI/2);
      const view = new Marzipano.RectilinearView(
        { yaw: sceneData.yaw||0, pitch: sceneData.pitch||0, fov: sceneData.fov||1.2 },
        limiter
      );
      const scene = viewer.createScene({ source, geometry, view, pinFirstLevel: true });
      scene.switchTo();

      document.getElementById('zoomIn').onclick = () => view.setFov(view.fov() * 0.9);
      document.getElementById('zoomOut').onclick = () => view.setFov(view.fov() / 0.9);
      document.getElementById('reset').onclick = () => view.setParameters({ yaw: 0, pitch: 0, fov: 1.2 });
    }
  </script>
</body>
</html>
