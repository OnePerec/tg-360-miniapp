<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
  <title>360¬∞ –ú–∏–Ω–∏-–∞–ø–ø</title>
  <style>
    html,body{margin:0;padding:0;width:100%;height:100%;overflow:hidden;background:#000}
    #pano{position:fixed;inset:0;width:100%;height:100%;touch-action:none}
    .toolbar{
      position:fixed;top:10px;left:10px;right:10px;display:flex;gap:8px;z-index:10;
      align-items:center;justify-content:space-between;padding:6px 10px;border-radius:12px;
      backdrop-filter:blur(6px);background:rgba(0,0,0,.35);color:#fff;
      font:14px/1.2 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    }
    .btn{border:0;padding:8px 12px;border-radius:10px;cursor:pointer;background:rgba(255,255,255,.9)}
  </style>
  <!-- –õ–æ–∫–∞–ª—å–Ω–∞—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ Marzipano -->
  <script src="libs/marzipano.min.js"></script>
  <!-- Telegram WebApp SDK (–±–µ–∑ MainButton) -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
  <div class="toolbar">
    <div>üì∑ 360¬∞ –ü—Ä–æ—Å–º–æ—Ç—Ä</div>
    <div>
      <button class="btn" id="zoomIn">+</button>
      <button class="btn" id="zoomOut">‚àí</button>
      <button class="btn" id="reset">Reset</button>
    </div>
  </div>
  <div id="pano"></div>

  <!-- –ö–æ–Ω—Ñ–∏–≥ —Ç—É—Ä–∞ (–∫—ç—à-–±—Ä–µ–π–∫–µ—Ä –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω!) -->
  <script src="data.js?v=5"></script>

  <script>
    // Mini App –∏ —Ç–µ–º–∞ (–±–µ–∑ MainButton)
    (function initTG(){
      const tg = window.Telegram && window.Telegram.WebApp ? window.Telegram.WebApp : null;
      if (tg){ tg.ready(); tg.expand(); const tp=tg.themeParams||{}; if(tp.bg_color) document.body.style.background=tp.bg_color; }
      else { console.log("Browser mode (Telegram WebApp SDK –Ω–µ—Ç)"); }
    })();

    // –°–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–≤–µ—Ä—Ö —ç–∫—Ä–∞–Ω–∞
    function overlay(html){
      const d=document.createElement('div');
      d.style.cssText='position:fixed;inset:0;display:grid;place-items:center;color:#fff;font:16px system-ui;background:rgba(0,0,0,.4);z-index:20';
      d.innerHTML=html; document.body.appendChild(d); return d;
    }

    function withCacheBuster(url){
      let parsed;
      try {
        parsed = new URL(url, window.location.href);
      } catch (e) {
        return url;
      }
      if (parsed.origin !== window.location.origin) return url;
      parsed.searchParams.set('_t', Date.now());
      if (/^https?:\/\//i.test(url) || url.startsWith('//')) {
        return parsed.toString();
      }
      const rebuilt = parsed.pathname + parsed.search + parsed.hash;
      if (url.startsWith('/')) return rebuilt;
      return rebuilt.startsWith('/') ? rebuilt.slice(1) : rebuilt;
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–∞–Ω–æ—Ä–∞–º—ã
    (function initPano(){
      if(!window.DATA || !window.DATA.scene || !window.DATA.scene.url){
        overlay('–£–∫–∞–∂–∏ –ø–∞–Ω–æ—Ä–∞–º—É –≤ <code>data.js</code>'); return;
      }
      const sceneData = window.DATA.scene;

      // –ü—Ä–æ–±–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞, —á—Ç–æ–±—ã –≤–∑—è—Ç—å —Ä–µ–∞–ª—å–Ω—É—é —à–∏—Ä–∏–Ω—É —Ç–µ–∫—Å—Ç—É—Ä—ã
      const img = new Image();
      img.crossOrigin = 'anonymous';
      img.onload = () => {
        const realW = img.naturalWidth || sceneData.width || 8000;

        const viewer = new Marzipano.Viewer(document.getElementById('pano'));
        const source = Marzipano.ImageUrlSource.fromString(withCacheBuster(sceneData.url));
        const geometry = new Marzipano.EquirectGeometry([{ width: realW }]);

        const minFov = 0.25; // ~14¬∞
        const maxFov = 1.5;  // ~86¬∞
        const limiter = Marzipano.RectilinearView.limit.zoom(minFov, maxFov);
        const view = new Marzipano.RectilinearView(
          { yaw: sceneData.yaw||0, pitch: sceneData.pitch||0, fov: sceneData.fov||1.2 },
          limiter
        );

        const scene = viewer.createScene({ source, geometry, view, pinFirstLevel:true });
        scene.switchTo();

        // –í–∫–ª—é—á–∞–µ–º –∂–µ—Å—Ç—ã/–∫–æ–ª–µ—Å–æ
        const controls = viewer.controls();
        controls.registerMethod('mouseViewDrag', new Marzipano.MouseViewDragHandler(view), true);
        controls.registerMethod('touchViewDrag', new Marzipano.TouchViewDragHandler(view), true);
        controls.registerMethod('scrollZoom',    new Marzipano.ScrollZoomHandler(view), true);
        controls.registerMethod('pinchZoom',     new Marzipano.PinchZoomHandler(view), true);

        // –ö–Ω–æ–ø–∫–∏ –∑—É–º–∞
        const clamp=(x,lo,hi)=>Math.max(lo,Math.min(hi,x));
        document.getElementById('zoomIn').onclick  = () => view.setFov( clamp(view.fov()*0.9, minFov, maxFov) );
        document.getElementById('zoomOut').onclick = () => view.setFov( clamp(view.fov()/0.9, minFov, maxFov) );
        document.getElementById('reset').onclick   = () => view.setParameters({ yaw:0, pitch:0, fov:1.2 });

        // iOS: –±–ª–æ–∫–∏—Ä—É–µ–º —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω–æ—á–Ω—ã–π –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–π —Å–≤–∞–π–ø (–Ω–µ –º–µ—à–∞–µ–º –ø–∏–Ω—á—É)
        (function guardIOS(){
          const el = document.getElementById('pano');
          let dragging=false, startY=0;
          el.addEventListener('touchstart',(e)=>{ if(e.touches.length===1){dragging=true; startY=e.touches[0].clientY;} else dragging=false; }, {passive:false});
          el.addEventListener('touchmove',(e)=>{ if(e.touches.length>=2) return; if(dragging && e.touches[0]){ const dy=e.touches[0].clientY-startY; if(Math.abs(dy)>2) e.preventDefault(); } }, {passive:false});
          el.addEventListener('touchend',()=>{ dragging=false; }, {passive:false});
        })();
      };
      img.onerror = () => overlay('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å: <b>'+sceneData.url+'</b>');
      img.src = withCacheBuster(sceneData.url);
    })();
  </script>
</body>
</html>
